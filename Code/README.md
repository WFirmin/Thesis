This is the (somewhat unorganized) code that I used in my thesis.
